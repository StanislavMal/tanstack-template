// üìÑ store/store.ts
import { Store } from '@tanstack/store'
import type { Message } from '../utils/ai'

export interface Prompt {
  id: string
  name: string
  content: string
  is_active: boolean
}

export interface UserSettings {
  model: 'gemini-1.5-flash' | 'gemini-1.5-pro'
  system_instruction: string
}

// -> –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±–∏—Ä–∞–µ–º –º–∞—Å—Å–∏–≤ 'messages' –æ—Ç—Å—é–¥–∞
export interface Conversation {
  id: string
  title: string
  user_id: string
  created_at: string
}

export interface State {
  prompts: Prompt[]
  settings: UserSettings | null
  conversations: Conversation[]
  // -> –ù–û–í–û–ï: –û—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π —Ç–µ–∫—É—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞
  currentMessages: Message[] 
  currentConversationId: string | null
  isLoading: boolean
}

const initialState: State = {
  prompts: [],
  settings: null,
  conversations: [],
  currentMessages: [], // -> –ù–û–í–û–ï
  currentConversationId: null,
  isLoading: false
}

export const store = new Store<State>(initialState)

export const actions = {
  // -> –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ–º –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
  setMessages: (messages: Message[]) => {
    store.setState(state => ({ ...state, currentMessages: messages }));
  },

  addMessage: (message: Message) => {
    store.setState(state => ({
      ...state,
      currentMessages: [...state.currentMessages, message]
    }));
  },

  editMessage: (messageId: string, newContent: string) => {
    store.setState(state => {
      const msgIndex = state.currentMessages.findIndex(m => m.id === messageId);
      if (msgIndex === -1) return state;
      
      const newMessages = [...state.currentMessages];
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
      newMessages[msgIndex] = { ...newMessages[msgIndex], content: newContent };
      // –û–±—Ä–µ–∑–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–æ—Å–ª–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
      const finalMessages = newMessages.slice(0, msgIndex + 1);

      return { ...state, currentMessages: finalMessages };
    });
  },

  // –û—Å—Ç–∞–ª—å–Ω—ã–µ actions
  setSettings: (settings: UserSettings) => {
    store.setState(state => ({ ...state, settings }));
  },
  
  setPrompts: (prompts: Prompt[]) => {
    store.setState(state => ({ ...state, prompts }));
  },

  setConversations: (conversations: Conversation[]) => {
    store.setState(state => ({ ...state, conversations }))
  },

  setCurrentConversationId: (id: string | null) => {
    store.setState(state => {
      // –ü—Ä–∏ —Å–º–µ–Ω–µ –¥–∏–∞–ª–æ–≥–∞ –æ—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
      if (state.currentConversationId !== id) {
        return { ...state, currentConversationId: id, currentMessages: [] };
      }
      return { ...state, currentConversationId: id };
    });
  },

  addConversation: (conversation: Conversation) => {
    store.setState(state => ({
      ...state,
      conversations: [conversation, ...state.conversations],
      currentConversationId: conversation.id,
      currentMessages: [] // –ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ –≤—Å–µ–≥–¥–∞ –ø—É—Å—Ç–æ–π
    }));
  },

  updateConversationTitle: (id: string, title: string) => {
    store.setState(state => ({
      ...state,
      conversations: state.conversations.map(conv =>
        conv.id === id ? { ...conv, title } : conv
      )
    }))
  },

  deleteConversation: (id: string) => {
    store.setState(state => ({
      ...state,
      conversations: state.conversations.filter(conv => conv.id !== id),
      currentConversationId: state.currentConversationId === id ? null : state.currentConversationId,
      // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Ç–µ–∫—É—â–∏–π, —á–∏—Å—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏—è
      currentMessages: state.currentConversationId === id ? [] : state.currentMessages,
    }));
  },
  
  setLoading: (isLoading: boolean) => {
    store.setState(state => ({ ...state, isLoading }))
  }
}

// Selectors
export const selectors = {
  getSettings: (state: State) => state.settings,
  getActivePrompt: (state: State) => state.prompts.find(p => p.is_active),
  getPrompts: (state: State) => state.prompts,
  getCurrentConversation: (state: State) => 
    state.conversations.find(c => c.id === state.currentConversationId),
  getConversations: (state: State) => state.conversations,
  getCurrentConversationId: (state: State) => state.currentConversationId,
  getIsLoading: (state: State) => state.isLoading,
  // -> –ù–û–í–û–ï: –°–µ–ª–µ–∫—Ç–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
  getCurrentMessages: (state: State) => state.currentMessages,
}